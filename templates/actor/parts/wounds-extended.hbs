{{!-- Extended Wounds Section with Paper Doll and Editable Wounds List --}}
<section class="combat-section wounds-section healing-panel-section">
    <div class="section-header">
        <div class="header-title">
            <i class="fas fa-crutch"></i>
            <span>{{localize "NEUROSHIMA.Items.Type.Wound"}}</span>
        </div>
        
        <div class="wound-stats-total">
            <span class="hp-sum" title="{{localize 'NEUROSHIMA.Wound.TotalDamage'}}">
                <i class="fas fa-heart"></i> {{combat.totalDamagePoints}} / {{combat.maxHP}}
            </span>
            <span class="penalty-sum" title="{{localize 'NEUROSHIMA.Wound.TotalPenalty'}}">
                <i class="fas fa-exclamation-triangle"></i> {{combat.totalWoundPenalty}}%
            </span>
        </div>

        <div class="header-actions">
            {{#if owner}}
            <a class="item-control" data-action="requestHealing" title="{{localize 'NEUROSHIMA.PatientCard.ShowPatientCard'}}">
                <i class="fas fa-file-medical"></i>
            </a>
            {{#if @root.game.user.isGM}}
            <a class="item-control" data-action="configureHP" title="{{localize 'NEUROSHIMA.Actions.ConfigureHP'}}">
                <i class="fas fa-cog"></i>
            </a>
            {{/if}}
            {{/if}}
        </div>
    </div>

    <div class="healing-panel-layout">
        {{!-- Paper Doll Section --}}
        <div class="healing-panel-section paper-doll-section">
            <h3 class="section-title">{{localize "NEUROSHIMA.HealingRequest.PaperDoll"}}</h3>
            
            <div class="selected-location-info">
                <p class="no-selection">{{localize "NEUROSHIMA.HealingRequest.SelectLocation"}}</p>
            </div>
            
            <div class="paper-doll-container">
                <svg class="body-diagram" viewBox="0 0 240 560" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
                    {{!-- Głowa --}}
                    <g data-location="head">
                        <circle cx="120" cy="55" r="42" class="body-location-hotspot" data-location="head" data-tooltip="{{localize 'NEUROSHIMA.Location.Head'}}" />
                        <text x="120" y="60" class="wound-count-badge" text-anchor="middle" dominant-baseline="middle">{{combat.locationsMap.head.wounds.length}}</text>
                    </g>
                    
                    {{!-- Tułów --}}
                    <g data-location="torso">
                        <rect x="92" y="110" width="56" height="160" class="body-location-hotspot" data-location="torso" data-tooltip="{{localize 'NEUROSHIMA.Location.Torso'}}" />
                        <text x="120" y="192" class="wound-count-badge" text-anchor="middle" dominant-baseline="middle">{{combat.locationsMap.torso.wounds.length}}</text>
                    </g>
                    
                    {{!-- Lewe ramię --}}
                    <g data-location="leftArm">
                        <rect x="40" y="125" width="45" height="110" class="body-location-hotspot" data-location="leftArm" data-tooltip="{{localize 'NEUROSHIMA.Location.LeftArm'}}" />
                        <text x="62" y="182" class="wound-count-badge" text-anchor="middle" dominant-baseline="middle">{{combat.locationsMap.leftArm.wounds.length}}</text>
                    </g>
                    
                    {{!-- Prawe ramię --}}
                    <g data-location="rightArm">
                        <rect x="155" y="125" width="45" height="110" class="body-location-hotspot" data-location="rightArm" data-tooltip="{{localize 'NEUROSHIMA.Location.RightArm'}}" />
                        <text x="177" y="182" class="wound-count-badge" text-anchor="middle" dominant-baseline="middle">{{combat.locationsMap.rightArm.wounds.length}}</text>
                    </g>
                    
                    {{!-- Lewa noga --}}
                    <g data-location="leftLeg">
                        <rect x="75" y="290" width="40" height="135" class="body-location-hotspot" data-location="leftLeg" data-tooltip="{{localize 'NEUROSHIMA.Location.LeftLeg'}}" />
                        <text x="95" y="357" class="wound-count-badge" text-anchor="middle" dominant-baseline="middle">{{combat.locationsMap.leftLeg.wounds.length}}</text>
                    </g>
                    
                    {{!-- Prawa noga --}}
                    <g data-location="rightLeg">
                        <rect x="125" y="290" width="40" height="135" class="body-location-hotspot" data-location="rightLeg" data-tooltip="{{localize 'NEUROSHIMA.Location.RightLeg'}}" />
                        <text x="145" y="357" class="wound-count-badge" text-anchor="middle" dominant-baseline="middle">{{combat.locationsMap.rightLeg.wounds.length}}</text>
                    </g>
                </svg>
            </div>
        </div>

        {{!-- Wounds List Section Grouped by Location --}}
        <div class="healing-panel-section wounds-list-section">
            <h3 class="section-title">{{localize "NEUROSHIMA.PatientCard.Wounds"}}</h3>
            <div class="wounds-list-container">
                {{#if combat.wounds.length}}
                    {{#each combat.patientData.locations as |location|}}
                    
                    {{!-- Location Header WYCIĄGNIĘTY POZA #with --}}
                    <div class="location-wounds-header {{#if (eq location.key "head")}}active{{/if}}" data-location="{{location.key}}">
                        <h4 class="location-wounds-title" data-location-debug="{{location.key}}">{{location.label}}</h4>
                        {{#if ../owner}}
                        <button type="button" class="btn-add-wound" data-action="createItem" data-type="wound" data-location="{{location.key}}" title="{{localize 'DOCUMENT.Create'}}">
                            <i class="fas fa-plus"></i>
                        </button>
                        {{/if}}
                    </div>
                    
                    {{!-- Wounds Group (Always rendered, shows wounds only if they exist) --}}
                    {{#with (lookup ../combat.woundsByLocation location.key) as |locationWounds|}}
                    <div class="location-wounds-group {{#if (eq ../location.key "head")}}active{{/if}}" data-location="{{../location.key}}">
                        {{#if (or locationWounds locationWounds.length)}}
                            {{#each locationWounds as |wound|}}
                            <div class="wound-item wound-item-inline item" data-item-id="{{wound.id}}" data-uuid="{{wound.uuid}}" draggable="true">
                                {{!-- Type, Name, and Inline Editing --}}
                                <div class="wound-item-content">
                                    {{#if ../../owner}}
                                    <select name="items.{{wound.id}}.system.damageType" class="wound-type-select" title="{{localize 'NEUROSHIMA.Items.Fields.DamageType'}}">
                                        {{selectOptions @root.config.damageTypes selected=wound.damageType localize=true}}
                                    </select>
                                    {{else}}
                                    <span class="wound-type">{{wound.damageType}}</span>
                                    {{/if}}
                                    <span class="wound-item-name">{{wound.name}}</span>
                                    
                                    {{!-- Penalty (inline, editable) --}}
                                    {{#if ../../owner}}
                                    <input type="number" name="items.{{wound.id}}.system.penalty" value="{{wound.penalty}}" class="wound-penalty-input" data-dtype="Number" min="0" max="100" title="{{localize 'NEUROSHIMA.Wound.TotalPenalty'}}" />
                                    {{else}}
                                    <span class="wound-penalty" title="{{localize 'NEUROSHIMA.Wound.TotalPenalty'}}">{{wound.penalty}}%</span>
                                    {{/if}}
                                    
                                    {{!-- Healing Days --}}
                                    <span class="wound-days" title="{{localize 'NEUROSHIMA.Wound.Days'}}">{{#if wound.estimatedHealingDays}}{{wound.estimatedHealingDays}}d{{else}}-{{/if}}</span>
                                    
                                    {{!-- Status Icons --}}
                                    <div class="wound-status-icons">
                                        {{#if wound.hadFirstAid}}<i class="fas fa-syringe" title="{{localize 'NEUROSHIMA.Skills.firstAid'}}"></i>{{/if}}
                                        {{#if wound.isHealing}}<i class="fas fa-medkit active" title="{{localize 'NEUROSHIMA.Actions.Healing'}}"></i>{{/if}}
                                        {{#if (gt wound.healingAttempts 0)}}<span class="attempts-badge" title="{{localize 'NEUROSHIMA.Wound.AttemptCount'}}">{{wound.healingAttempts}}×</span>{{/if}}
                                    </div>
                                    
                                    {{!-- Controls --}}
                                    {{#if ../../owner}}
                                    <div class="wound-inline-controls">
                                        <a class="item-control {{#if wound.isHealing}}active{{/if}}" data-action="toggleHealing" title="{{localize 'NEUROSHIMA.Actions.Healing'}}">
                                            <i class="fas fa-medkit"></i>
                                        </a>
                                        <a class="item-control" data-action="deleteItem" title="{{localize 'DOCUMENT.Delete'}}">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                    {{/if}}
                                </div>
                            </div>
                            {{/each}}
                        {{else}}
                            <p class="no-wounds-in-location" style="text-align: center; padding: 8px; opacity: 0.6;">{{localize 'NEUROSHIMA.PatientCard.NoWounds'}}</p>
                        {{/if}}
                    </div>
                    {{/with}}
                    {{/each}}
                {{else}}
                    <div class="no-wounds-message">
                        <i class="fas fa-check-circle"></i>
                        <p>{{localize "NEUROSHIMA.PatientCard.NoWounds"}}</p>
                    </div>
                {{/if}}
            </div>
        </div>
    </div>
</section>
