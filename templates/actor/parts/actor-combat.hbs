<section class="tab combat {{tabs.combat.cssClass}}" data-group="primary" data-tab="combat" data-application-part="combat">
    <div class="combat-grid">
        {{!-- Top Row: Armor and Weapons --}}
        <div class="combat-top-row">
            {{!-- Anatomical Armor Section --}}
            <section class="combat-section armor-section-anatomical">
                <div class="section-header">
                    <i class="fas fa-shield-alt"></i>
                    <span>{{localize "NEUROSHIMA.Items.Type.Armor"}}</span>
                    <div class="armor-penalty-total">
                        <span>{{localize "NEUROSHIMA.Armor.TotalPenalty"}}: <strong>{{combat.totalArmorPenalty}}%</strong></span>
                    </div>
                </div>
                
                <div class="armor-anatomical-grid">
                    {{#each combat.anatomicalArmor as |location key|}}
                    <div class="armor-location-box armor-{{key}} {{#if location.items.length}}has-items{{else}}empty{{/if}}">
                        <div class="location-header">
                            <span class="location-name">{{localize location.label}}</span>
                            {{#if location.items.length}}
                            <span class="location-ap-sum" title="{{localize "NEUROSHIMA.Armor.SumAP"}}">{{location.totalAP}}</span>
                            {{/if}}
                        </div>
                        {{#if location.items.length}}
                        <div class="armor-column-headers">
                            <span class="armor-header-icon"></span>
                            <span class="armor-header-name">{{localize "Name"}}</span>
                            <span class="armor-header-dur">{{localize "NEUROSHIMA.Items.Fields.DurabilityAbbr"}}</span>
                            <span class="armor-header-ap">AP</span>
                        </div>
                        <div class="location-armor-list">
                            {{#each location.items as |armor|}}
                            <div class="armor-item-row item" data-item-id="{{armor.id}}" data-uuid="{{armor.uuid}}" draggable="true">
                                <img src="{{armor.img}}" class="armor-icon-tiny" alt="{{armor.name}}">
                                <span class="armor-name-tiny clickable" data-action="editItem">{{armor.name}}</span>
                                <span class="armor-durability clickable {{#if (lt armor.currentDurability armor.durability)}}is-damaged{{/if}}" 
                                      data-action="modifyDurability" 
                                      data-item-id="{{armor.id}}" 
                                      title="LPM: {{localize "NEUROSHIMA.Actions.Repair"}} | PPM: {{localize "NEUROSHIMA.Actions.Damage"}}">
                                    {{armor.currentDurability}}
                                </span>
                                <span class="armor-ap-value clickable {{#if (lt armor.currentRating armor.rating)}}is-damaged{{/if}}" 
                                      data-action="modifyAP" 
                                      data-item-id="{{armor.id}}" 
                                      data-location="{{key}}"
                                      title="LPM: {{localize "NEUROSHIMA.Actions.Repair"}} | PPM: {{localize "NEUROSHIMA.Actions.Damage"}}">
                                    {{armor.currentRating}}
                                </span>
                            </div>
                            {{/each}}
                        </div>
                        {{else}}
                        <div class="location-empty">{{localize "NEUROSHIMA.Armor.None"}}</div>
                        {{/if}}
                    </div>
                    {{/each}}
                </div>
            </section>

            {{!-- Equipped Weapons Section --}}
            <section class="combat-section weapons-section">
                <div class="section-header">
                    <i class="fas fa-fist-raised"></i>
                    <span>{{localize "NEUROSHIMA.Items.Type.Weapon"}}</span>
                </div>
                <div class="combat-weapons-list">
                    {{#each combat.weapons as |weapon|}}
                    <div class="equipment-item weapon-item-clickable item" data-item-id="{{weapon.id}}" data-uuid="{{weapon.uuid}}" draggable="true">
                        <img src="{{weapon.img}}" class="weapon-icon" alt="{{weapon.name}}">
                        <div class="weapon-info-column">
                            <div class="weapon-name-rollable clickable" data-action="rollWeapon">{{weapon.name}}</div>
                            <div class="weapon-stats-row">
                                <span class="stat-item">
                                    <span class="stat-label" title="{{localize "NEUROSHIMA.Items.Fields.Damage"}}">Obr.:</span>
                                    <span class="stat-value">{{weapon.damage}}</span>
                                </span>
                                <span class="stat-separator">|</span>
                                {{#if (eq weapon.type "melee")}}
                                <span class="stat-item">
                                    <span class="stat-label" title="{{localize "NEUROSHIMA.Items.Fields.AttackBonus"}}">Atak:</span>
                                    <span class="stat-value">{{weapon.attack}}</span>
                                </span>
                                <span class="stat-separator">|</span>
                                <span class="stat-item">
                                    <span class="stat-label" title="{{localize "NEUROSHIMA.Items.Fields.DefenseBonus"}}">Obrona:</span>
                                    <span class="stat-value">{{weapon.defense}}</span>
                                </span>
                                {{else}}
                                <span class="stat-item">
                                    <span class="stat-label" title="{{localize "NEUROSHIMA.Items.Fields.Piercing"}}">PP:</span>
                                    <span class="stat-value">{{weapon.piercing}}</span>
                                </span>
                                <span class="stat-separator">|</span>
                                <span class="stat-item">
                                    <span class="stat-label" title="{{localize "NEUROSHIMA.Items.Fields.FireRate"}}">RoF:</span>
                                    <span class="stat-value">{{weapon.fireRate}}</span>
                                </span>
                                <span class="stat-separator">|</span>
                                <span class="stat-item">
                                    <span class="stat-label" title="{{localize "NEUROSHIMA.Items.Fields.Jamming"}}">Zac.:</span>
                                    <span class="stat-value">{{weapon.jamming}}</span>
                                </span>
                                {{/if}}
                            </div>
                            {{#if weapon.magazine}}
                            <div class="weapon-magazine-row">
                                <span class="stat-label">{{localize "NEUROSHIMA.Items.Fields.Magazine"}}:</span>
                                <div class="magazine-info-container" title="{{weapon.magazine.tooltip}}">
                                    <div class="magazine-capacity-bar">
                                        {{weapon.magazine.count}} / {{weapon.magazine.max}}
                                    </div>
                                </div>
                            </div>
                            {{else if (and (eq weapon.type "thrown") weapon.ammoName)}}
                            <div class="weapon-magazine-row">
                                <span class="stat-label">{{localize "NEUROSHIMA.Items.Fields.Ammo"}}:</span>
                                <div class="magazine-info-container">
                                    <span class="ammo-name">{{weapon.ammoName}} ({{weapon.ammoCount}})</span>
                                </div>
                            </div>
                            {{/if}}
                        </div>
                        <div class="weapon-edit-column">
                            <a class="item-control" data-action="editItem" title="{{localize "NEUROSHIMA.Sheet.Edit"}}">
                                <i class="fas fa-edit"></i>
                            </a>
                        </div>
                    </div>
                    {{/each}}
                </div>
            </section>
        </div>

        {{!-- Bottom Row: Wounds --}}
        <section class="combat-section wounds-section">
            <div class="section-header">
                <div class="header-title">
                    <i class="fas fa-crutch"></i>
                    <span>{{localize "NEUROSHIMA.Items.Type.Wound"}}</span>
                </div>
                
                <div class="wound-stats-total">
                    <span class="hp-sum" title="{{localize "NEUROSHIMA.Wound.TotalDamage"}}">
                        <i class="fas fa-heart"></i> {{combat.totalDamagePoints}} / {{combat.maxHP}}
                    </span>
                    <span class="penalty-sum" title="{{localize "NEUROSHIMA.Wound.TotalPenalty"}}">
                        <i class="fas fa-exclamation-triangle"></i> {{combat.totalWoundPenalty}}%
                    </span>
                </div>

                <div class="header-actions">
                    {{#if owner}}
                    {{#if @root.game.user.isGM}}
                    <a class="item-control" data-action="configureHP" title="{{localize 'NEUROSHIMA.Actions.ConfigureHP'}}">
                        <i class="fas fa-cog"></i>
                    </a>
                    {{/if}}
                    <a class="item-control" data-action="createItem" data-type="wound" title="{{localize 'DOCUMENT.Create'}}">
                        <i class="fas fa-plus"></i>
                    </a>
                    {{/if}}
                </div>
            </div>
            <div class="combat-table wounds-table">
                <div class="table-header">
                    <div class="col-name">{{localize "Name"}}</div>
                    <div class="col-location">{{localize "NEUROSHIMA.Items.Fields.Location"}}</div>
                    <div class="col-type">{{localize "NEUROSHIMA.Items.Fields.DamageType"}}</div>
                    <div class="col-penalty">{{localize "NEUROSHIMA.Items.Fields.Penalty"}}</div>
                    <div class="col-controls"></div>
                </div>
                {{#each combat.wounds}}
                <div class="table-row item" data-item-id="{{this.id}}" data-uuid="{{this.uuid}}" draggable="true">
                    <div class="col-name item-name clickable" data-action="editItem">
                        <img src="{{this.img}}" title="{{this.name}}" width="24" height="24"/>
                        <span>{{this.name}}</span>
                    </div>
                    <div class="col-location">
                        <select name="items.{{this.id}}.system.location">
                            {{selectOptions @root.config.locations selected=this.system.location localize=true}}
                        </select>
                    </div>
                    <div class="col-type">
                        <select name="items.{{this.id}}.system.damageType">
                            {{selectOptions @root.config.damageTypes selected=this.system.damageType localize=true}}
                        </select>
                    </div>
                    <div class="col-penalty">
                        <input type="number" name="items.{{this.id}}.system.penalty" value="{{this.system.penalty}}" data-dtype="Number" min="0" />
                    </div>
                    <div class="col-controls">
                        <a class="item-control {{#if this.system.isHealing}}active{{/if}}" data-action="toggleHealing" title="{{localize 'NEUROSHIMA.Actions.Healing'}}">
                            <i class="fas fa-medkit"></i>
                        </a>
                        <a class="item-control" data-action="editItem" title="{{localize 'NEUROSHIMA.Sheet.Edit'}}">
                            <i class="fas fa-edit"></i>
                        </a>
                        <a class="item-control" data-action="deleteItem" title="{{localize 'DOCUMENT.Delete'}}">
                            <i class="fas fa-trash"></i>
                        </a>
                    </div>
                </div>
                {{/each}}
            </div>
        </section>
    </div>
</section>
